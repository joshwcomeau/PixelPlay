function GameController(e,t,o,s){this.manager=t,t.countriesAndCities=s,t.initialize()}function GlobalController(e,t,o){var s=this;s.manager=o,s.currentUser=null,s.userService=t,e.$on("userAuthenticated",function(t,o){e.$apply(function(){s.currentUser=o,console.log(o)})})}function answerWithNumbers(e){return{restrict:"A",link:function(){e.bind("keyup",function(e){49===e.which?($("#answer-1").click(),$("#answer-1 .number-label").removeAttr("style")):50===e.which?($("#answer-2").click(),$("#answer-2 .number-label").removeAttr("style")):51===e.which&&($("#answer-3").click(),$("#answer-3 .number-label").removeAttr("style"))}),e.bind("keydown",function(e){49===e.which?$("#answer-1 .number-label").css({background:"#347b8e"}):50===e.which?$("#answer-2 .number-label").css({background:"#347b8e"}):51===e.which&&$("#answer-3 .number-label").css({background:"#347b8e"})})}}}function FetchCities(e){return e("/api/cities")}function FetchPhotosFrom500px(e){return{allPhotos:[],filteredPhotos:[],maxSizePhotos:[],photos:[],query:function(t){console.log("Querying");var o=e.defer(),s={feature:"fresh_today",only:"Urban Exploration",image_size:5,rpp:100},r=_.merge(s,t);return _this=this,_500px.api("/photos",r,function(e){e.success?(_this.allPhotos=e.data.photos,_this.filteredPhotos=_this.appropriateForGame(e.data.photos),_this.maxSizePhotos=_this.getMaxSize(_this.filteredPhotos),_this.photos=_this.maxSizePhotos,o.resolve({success:!0})):o.reject({success:!1,status:e.status,message:e.error_message})}),o.promise},appropriateForGame:function(e){return _.filter(e,function(e){return null!==e.latitude&&null!==e.longitude&&e.width>=1200&&e.width>e.height&&e.width<=2*e.height})},getMaxSize:function(e){return console.log("maxSize"),_.map(e,function(e){return e.image_url=e.image_url.substr(0,e.image_url.length-5)+"2048.jpg",e})}}}function FetchPhotosFrom500px(e){return{allPhotos:[],filteredPhotos:[],maxSizePhotos:[],photos:[],query:function(t){console.log("Querying");var o=e.defer(),s={feature:"fresh_today",only:"Urban Exploration",image_size:5,rpp:100},r=_.merge(s,t);return _this=this,_500px.api("/photos",r,function(e){e.success?(_this.allPhotos=e.data.photos,_this.filteredPhotos=_this.appropriateForGame(e.data.photos),_this.maxSizePhotos=_this.getMaxSize(_this.filteredPhotos),_this.photos=_this.maxSizePhotos,o.resolve({success:!0})):o.reject({success:!1,status:e.status,message:e.error_message})}),o.promise},appropriateForGame:function(e){return _.filter(e,function(e){return null!==e.latitude&&null!==e.longitude&&e.width>=1200&&e.width>e.height&&e.width<=2*e.height})},getMaxSize:function(e){return console.log("maxSize"),_.map(e,function(e){return e.image_url=e.image_url.substr(0,e.image_url.length-5)+"2048.jpg",e})}}}function GameManager(e,t,o,s,r,i,n){var a=this;this.initialize=function(){this.score=0,this.combo=0,this.photos=[],this.loadedPhotos=[],this.currentPhoto=null,this.currentAnswers=null,this.currentQuestion=0,this.chosenAnswer=null,this.page=1,this.preloadsLeft=3,this.loadPercent=0,this.loadPieces=5,this.resultsSplash=null,this.state="initial",this.mode=null},this.selectMode=function(e){console.log("SELECTING MODE ",e),"fresh"===e&&"initial"===a.state&&(a.updateLoadBar(),s.query().then(function(){a.photos=s.photos,a.preloadQuestion(a.numToPreload),a.updateLoadBar()}),a.state="loading")},this.startGame=function(){this.state="running"},this.setupGame=function(){this.currentPhoto=this.loadedPhotos.shift(),this.currentAnswers=this.buildAnswers(),this.state="waiting"},this.updateLoadBar=function(){this.loadPercent+=1/a.loadPieces*100},this.preloadQuestion=function(){var e,t,s=350;t=(new Date).getTime(),e=a.photos[0],console.log("Calling to preload, with this many left: ",a.preloadsLeft),o.all({getImage:i.preloadImages([e]),getLocation:n.getLocation(e)}).then(function(o){e.location=o.getLocation.location,a.loadedPhotos.push(e),a.photos.shift(),a.preloadsLeft>0&&a.preloadsLeft--,a.updateLoadBar(),a.preloadsLeft?a.waitAndPreloadAnother(t,s):"loading"===a.state&&a.setupGame()},function(){a.photos.shift(),a.waitAndPreloadAnother(t,s)})},this.waitAndPreloadAnother=function(e,o){var s,r,i;s=(new Date).getTime(),r=s-e,o>r?(i=o-r,t(a.preloadQuestion,i)):a.preloadQuestion()},this.submitAnswer=function(e){null===this.resultsSplash&&(this.chosenAnswer=e,this.currentPhoto.location.city===e.city?(this.score++,this.combo++,this.resultsSplash=!0):(this.resultsSplash=!1,this.combo=0),this.preloadQuestion(),this.photos.length<10&&(this.page++,s.query({page:this.page}).then(function(){_.forEach(s.filteredPhotos,function(e){a.photos.push(e)})})),t(function(){a.currentPhoto=a.loadedPhotos.shift(),console.log(a.currentPhoto)},150))},this.goToNextQuestion=function(){this.chosenAnswer=null,this.currentQuestion++,this.currentAnswers=this.buildAnswers(),this.resultsSplash=null},this.buildAnswers=function(){var e=this.pickRandomCity(),t=e;for(this.rightAnswer=this.currentPhoto.location;e.city===t.city;)t=this.pickRandomCity();return _.shuffle([this.rightAnswer,e,t])},this.pickRandomCity=function(){var e,t,o;return e=_.sample(this.countriesAndCities),t=e.country,o=_.sample(e.cities),{country:t,city:o}}}angular.module("pixelPlay.game",[]),angular.module("pixelPlay.score",[]),angular.module("appRoutes",[]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"/components/dashboard/dashboard.index.html"}).when("/game",{templateUrl:"/components/game/game.index.html",controller:"GameController",controllerAs:"game",resolve:GameController.resolve}),t.html5Mode(!0)}]),angular.module("pixelPlay",["ngAnimate","ngRoute","ngResource","appRoutes","pixelPlay.game","pixelPlay.score"]).run(["User","$rootScope",function(e){_500px.init({sdk_key:"1e6cd00470800d39b07106a70a650cdf88277901"}),console.log("500px initialized"),_500px.getAuthorizationStatus(e.updateUser)}]),GameController.resolve={bogusAnswers:["FetchCities",function(e){return e.query().$promise}]},GameController.$inject=["$scope","GameManager","FetchPhotosFrom500px","bogusAnswers"],angular.module("pixelPlay.game").controller("GameController",["$scope","GameManager","FetchPhotosFrom500px","bogusAnswers",GameController]),GlobalController.$inject=["$scope","User","GameManager"],angular.module("pixelPlay").controller("GlobalController",["$scope","User","GameManager",GlobalController]),angular.module("pixelPlay.score").factory("Score",["$resource",function(e){return e("/api/scores/:id")}]),angular.module("pixelPlay").service("User",["$rootScope","Score",function(e){var t=this;t.currentUser=null,t.data=null,t.login=function(){_500px.login(t.updateUser)},t.logout=function(){_500px.logout(t.updateUser)},t.updateUser=function(o){"authorized"===o?_500px.api("/users",function(o){console.log(o),t.currentUser=o.data.user,t.data=o,e.$broadcast("userAuthenticated",o.data.user)}):(console.log("updateUser is logging out"),t.currentUser=t.data=null)}}]),angular.module("pixelPlay").directive("answerWithNumbers",["$document","GameManager",answerWithNumbers]),angular.module("pixelPlay.game").factory("FetchCities",["$resource",FetchCities]),angular.module("pixelPlay.game").factory("FetchPhotosFrom500px",["$q",FetchPhotosFrom500px]),angular.module("pixelPlay.game").factory("FetchPhotosFrom500px",["$q",FetchPhotosFrom500px]),angular.module("pixelPlay.game").service("GameManager",["$interval","$timeout","$q","FetchPhotosFrom500px","FetchCities","Preloader","ReverseGeocoder",GameManager]),angular.module("pixelPlay").factory("Preloader",["$q","$rootScope",function(e,t){function o(t){this.imageLocations=_.map(t,function(e){return e.image_url}),this.imageCount=this.imageLocations.length,this.loadCount=0,this.errorCount=0,this.states={PENDING:1,LOADING:2,RESOLVED:3,REJECTED:4},this.state=this.states.PENDING,this.deferred=e.defer(),this.promise=this.deferred.promise}return o.preloadImages=function(e){var t=new o(e);return t.load()},o.prototype={constructor:o,isInitiated:function(){return this.state!==this.states.PENDING},isRejected:function(){return this.state===this.states.REJECTED},isResolved:function(){return this.state===this.states.RESOLVED},load:function(){if(this.isInitiated())return this.promise;this.state=this.states.LOADING;for(var e=0;e<this.imageCount;e++)this.loadImageLocation(this.imageLocations[e]);return this.promise},handleImageError:function(e){this.errorCount++,this.isRejected()||(this.state=this.states.REJECTED,this.deferred.reject(e))},handleImageLoad:function(e){this.loadCount++,this.isRejected()||(this.deferred.notify({percent:Math.ceil(this.loadCount/this.imageCount*100),imageLocation:e}),this.loadCount===this.imageCount&&(this.state=this.states.RESOLVED,this.deferred.resolve(this.imageLocations)))},loadImageLocation:function(e){var o=this,s=$(new Image).load(function(e){t.$apply(function(){o.handleImageLoad(e.target.src),o=s=e=null})}).error(function(e){t.$apply(function(){o.handleImageError(e.target.src),o=s=e=null})}).prop("src",e)}},o}]),angular.module("pixelPlay").factory("ReverseGeocoder",["$q","$interval",function(e){var t=new google.maps.Geocoder,o=function(e){var t,o=e[0].address_components,s=[];return _.forEach(o,function(e){"locality"===e.types[0]?s.unshift(e.long_name):"administrative_area"===e.types[0].substr(0,19)?s.push(e.long_name):"country"===e.types[0]&&(t=e.long_name)}),{city:s[0],country:t}};return{getLocation:function(s){var r,i=s.latitude,n=s.longitude,a=new google.maps.LatLng(i,n),l=e.defer();return t.geocode({latLng:a},function(e,t){t==google.maps.GeocoderStatus.OK?e[1]?(r=o(e),r.city&&r.country?l.resolve({location:o(e)}):l.reject({location:null})):alert("No results found"):(alert("Geocoder failed due to: "+t),l.reject({location:null}))}),l.promise}}}]);
//# sourceMappingURL=main.min.js.map