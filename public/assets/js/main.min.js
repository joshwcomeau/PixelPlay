function FetchCities(t){return t("/api/cities")}function FetchPhotos(t){return{allPhotos:[],filteredPhotos:[],query:function(e){var o=t.defer(),i={feature:"fresh_today",only:"Urban Exploration",image_size:5,rpp:100},n=_.merge(i,e);return _this=this,_500px.api("/photos",n,function(t){t.success?(_this.allPhotos=t.data.photos,_this.filteredPhotos=_this.appropriateForGame(t.data.photos),o.resolve({success:!0})):o.reject({success:!1,status:t.status,message:t.error_message})}),o.promise},appropriateForGame:function(t){return _.filter(t,function(t){return null!==t.latitude&&null!==t.longitude&&t.width>=1200&&t.width>t.height})}}}function GameController(t,e,o,i){this.manager=e,e.photos=o.filteredPhotos,e.countriesAndCities=i,e.initialize()}function GameManager(t,e,o,i,n,s,r){var a=this;this.initialize=function(){this.countriesAndCities,this.photos,this.score=0,this.loadedPhotos=[],this.currentPhoto=null,this.currentAnswers=null,this.currentQuestion=0,this.page=1,this.resultsSplash=null,this.loading=!1,this.loadPercent=0,this.state="initial",this.preloadQuestions(3)},this.startGame=function(){this.state="running"},this.setupGame=function(){this.currentPhoto=this.loadedPhotos.shift(),this.currentAnswers=this.buildAnswers(),this.state="waiting"},this.preloadQuestions=function(t){function i(){l=(new Date).getTime(),n=a.photos[0],o.all({getImage:s.preloadImages([n]),getLocation:r.getLocation(n)}).then(function(o){n.location=o.getLocation.location,console.log(n.location),a.loadedPhotos.push(n),a.photos.shift(),d++,a.loadPercent=d/t*100,d===t?(a.loading=!1,"initial"===a.state&&a.setupGame()):(u=(new Date).getTime(),c=u-l,g>c?(h=g-c,e(i,h)):i())})}var n,l,u,c,h,d=0,g=200;a.loading=!0,t=t||1,i()},this.submitAnswer=function(t){this.currentPhoto.location.city===t.city?(this.score++,this.resultsSplash=!0):this.resultsSplash=!1,this.preloadQuestions(),this.photos.length<22&&(this.page++,i.query({page:this.page}).then(function(){_.forEach(i.filteredPhotos,function(t){a.photos.push(t)}),unique_ids=_.chain(a.photos).map(function(t){return t.id}).uniq().value(),console.log(unique_ids)})),e(function(){a.currentPhoto=a.loadedPhotos.shift()},100)},this.goToNextQuestion=function(){this.currentQuestion++,this.currentAnswers=this.buildAnswers(),this.resultsSplash=null},this.buildAnswers=function(){for(var t=this.currentPhoto.location,e=this.pickRandomCity(),o=e;e.city===o.city;)o=this.pickRandomCity();var i=_.shuffle([t,e,o]);return i},this.pickRandomCity=function(){var t,e,o;return t=_.sample(this.countriesAndCities),e=t.country,o=_.sample(t.cities),{country:e,city:o}}}function GlobalController(t,e,o){var i=this;i.manager=o,i.currentUser=null,i.userService=e,t.$on("userAuthenticated",function(e,o){t.$apply(function(){i.currentUser=o,console.log(o)})})}angular.module("pixelPlay.game",[]),angular.module("pixelPlay.score",[]),angular.module("appRoutes",[]).config(["$routeProvider","$locationProvider",function(t,e){t.when("/",{templateUrl:"/components/dashboard/dashboard.index.html"}).when("/game",{templateUrl:"/components/game/game.index.html",controller:"GameController",controllerAs:"game",resolve:GameController.resolve}),e.html5Mode(!0)}]),angular.module("pixelPlay",["ngAnimate","ngRoute","ngResource","appRoutes","pixelPlay.game","pixelPlay.score"]).run(["User","$rootScope",function(t){_500px.init({sdk_key:"1e6cd00470800d39b07106a70a650cdf88277901"}),console.log("500px initialized"),_500px.getAuthorizationStatus(t.updateUser)}]),angular.module("pixelPlay.game").factory("FetchCities",["$resource",FetchCities]),angular.module("pixelPlay.game").factory("FetchPhotos",["$q",FetchPhotos]),GameController.resolve={getPhotos:["FetchPhotos",function(t){return t.query()}],bogusAnswers:["FetchCities",function(t){return t.query().$promise}]},GameController.$inject=["$scope","GameManager","FetchPhotos","bogusAnswers"],angular.module("pixelPlay.game").controller("GameController",["$scope","GameManager","FetchPhotos","bogusAnswers",GameController]),angular.module("pixelPlay.game").service("GameManager",["$interval","$timeout","$q","FetchPhotos","FetchCities","Preloader","ReverseGeocoder",GameManager]),GlobalController.$inject=["$scope","User","GameManager"],angular.module("pixelPlay").controller("GlobalController",["$scope","User","GameManager",GlobalController]),angular.module("pixelPlay.score").factory("Score",["$resource",function(t){return t("/api/scores/:id")}]),angular.module("pixelPlay").service("User",["$rootScope","Score",function(t){var e=this;e.currentUser=null,e.data=null,e.login=function(){_500px.login(e.updateUser)},e.logout=function(){_500px.logout(e.updateUser)},e.updateUser=function(o){"authorized"===o?_500px.api("/users",function(o){console.log(o),e.currentUser=o.data.user,e.data=o,t.$broadcast("userAuthenticated",o.data.user)}):(console.log("updateUser is logging out"),e.currentUser=e.data=null)}}]),angular.module("pixelPlay").factory("Preloader",["$q","$rootScope",function(t,e){function o(e){this.imageLocations=_.map(e,function(t){return t.image_url}),this.imageCount=this.imageLocations.length,this.loadCount=0,this.errorCount=0,this.states={PENDING:1,LOADING:2,RESOLVED:3,REJECTED:4},this.state=this.states.PENDING,this.deferred=t.defer(),this.promise=this.deferred.promise}return o.preloadImages=function(t){var e=new o(t);return e.load()},o.prototype={constructor:o,isInitiated:function(){return this.state!==this.states.PENDING},isRejected:function(){return this.state===this.states.REJECTED},isResolved:function(){return this.state===this.states.RESOLVED},load:function(){if(this.isInitiated())return this.promise;this.state=this.states.LOADING;for(var t=0;t<this.imageCount;t++)this.loadImageLocation(this.imageLocations[t]);return this.promise},handleImageError:function(t){this.errorCount++,this.isRejected()||(this.state=this.states.REJECTED,this.deferred.reject(t))},handleImageLoad:function(t){this.loadCount++,this.isRejected()||(this.deferred.notify({percent:Math.ceil(this.loadCount/this.imageCount*100),imageLocation:t}),this.loadCount===this.imageCount&&(this.state=this.states.RESOLVED,this.deferred.resolve(this.imageLocations)))},loadImageLocation:function(t){var o=this,i=$(new Image).load(function(t){e.$apply(function(){o.handleImageLoad(t.target.src),o=i=t=null})}).error(function(t){e.$apply(function(){o.handleImageError(t.target.src),o=i=t=null})}).prop("src",t)}},o}]),angular.module("pixelPlay").factory("ReverseGeocoder",["$q","$interval",function(t){var e=new google.maps.Geocoder,o=function(t){var e,o=t[0].address_components,i=[];return _.forEach(o,function(t){"locality"===t.types[0]?i.unshift(t.long_name):"administrative_area"===t.types[0].substr(0,19)?i.push(t.long_name):"country"===t.types[0]&&(e=t.long_name)}),{city:i[0],country:e}};return{getLocation:function(i){var n=i.latitude,s=i.longitude,r=new google.maps.LatLng(n,s),a=t.defer();return e.geocode({latLng:r},function(t,e){e==google.maps.GeocoderStatus.OK?t[1]?(console.log(o(t)),a.resolve({location:o(t)})):(alert("No results found"),a.reject({location:null})):(alert("Geocoder failed due to: "+e),a.reject({location:null}))}),a.promise}}}]);
//# sourceMappingURL=main.min.js.map